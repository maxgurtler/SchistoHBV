---
title: "SCHISTO-HBV"
subtitle: "SEN-B"
author: "Max Gurtler"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_float: true
date: "2024-05-27"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
options(repos = c(CRAN = "https://cran.r-project.org"))
if(!require('pacman')) install.packages('pacman')
pacman::p_load(tidyverse, here, janitor, dplyr, knitr, lubridate, reactable, gtsummary)
```

```{r}
rm(list = ls())
```

# FIRST STEPS

Dataset manipulation in 'bl_schisto_long_25052024_BW'.

```{r}
load("data/bl_schisto_wide_25052024_BW.Rdata")
reactable(bl_schisto_wide_25052024_BW)
```

## Exclusion of HIV-HBV co-infected patients

```{r}
library(dplyr)
library(haven)
library(labelled)

bl_schisto_wide_25052024_BW$hiv_status <- as.character(as_factor(bl_schisto_wide_25052024_BW$hiv_status))

bl_schisto_wide_25052024_noCoInf <- bl_schisto_wide_25052024_BW %>% 
  filter(hiv_status == "HBV")
```

```{r}
rm(list = "bl_schisto_wide_25052024_BW")
```


```{r}
reactable(bl_schisto_wide_25052024_noCoInf)
```

```{r}
# what values do we find in the 'hiv_status' column ?
unique_values <- unique(bl_schisto_wide_25052024_noCoInf$hiv_status)
print(unique_values)

# patient count
bl_schisto_wide_25052024_noCoInf %>%
  arrange(pid) %>% 
  distinct(pid) %>%
  nrow()
```


## Create 'CCA_Fb' dataset with HBV-monoinfected patients who have been tested for CCA (n = 721)

```{r}
CCA_Fb <- bl_schisto_wide_25052024_noCoInf %>%
  select(pid, cca_res, cca_bl_date, fibs_med_res, fibs_iqr_res, cap_med_res, cap_iqr_res) %>% 
  filter(!is.na(cca_res))

reactable(CCA_Fb)

# checking for duplicates
CCA_Fb %>% 
  get_dupes
```


## Create 'SENB_noCCA' dataset with patients (both mono- & co-infected) who have never been tested for CCA (n = 127)

```{r}
# load dataset before exclusion of HIV/HBV patients
load("data/bl_schisto_wide_25052024_BW.Rdata")

SENB_noCCA <- bl_schisto_wide_25052024_BW %>%
  select(pid, enrol_d, cca_res, cca_bl_date, fibs_med_res, fibs_iqr_res, cap_med_res, cap_iqr_res) %>%
  rename(fibs_med = fibs_med_res) %>% 
  rename(fibs_iqr = fibs_iqr_res) %>% 
  rename(cap_med = cap_med_res) %>% 
  rename(cap_iqr = cap_iqr_res) %>% 
  filter(is.na(cca_res))

reactable(SENB_noCCA)

# checking for duplicates
SENB_noCCA %>% 
  get_dupes
```

```{r}
rm(list = "bl_schisto_wide_25052024_BW")
```


## List of SENB patients to be tested for CCA

```{r}
patient_list <- as.list(SENB_noCCA$pid)
cat(paste(patient_list, collapse = ", "))
```

### We want a table with the pids but also the enrolment date for the FibroScan so we can find the Urine samples easily in the lab

```{r}
# import long table
load("data/bl_schisto_long_25052024_BW.Rdata")

# create 'CCA_Fb_long' dataset with variables of interest only
CCA_Fb_long <- bl_schisto_long_25052024_BW %>%   
  select(pid, enrol_d, test_dt, cca_res, fibs_med, fibs_iqr, cap_med, cap_iqr, hiv_status)

# unlabelling 'cca_res'
CCA_Fb_long$cca_res <- as.character(as_factor(CCA_Fb_long$cca_res))

# unlabelling 'hiv_status'
CCA_Fb_long$hiv_status <- as.character(as_factor(CCA_Fb_long$hiv_status))

# create 'df2' dataset with fibs_date
df2 <- CCA_Fb_long %>%
  group_by(pid) %>%
  mutate(fibs_date = case_when(!is.na(fibs_med) & !is.na(cap_med) ~ test_dt)) %>% # create variable 'fibs_date'
  fill(fibs_date, .direction = "downup") %>%
  ungroup() %>%
  filter(!is.na(fibs_date)) %>% 
  filter(is.na(cca_res)) %>% 
  select(-test_dt)

# join both datasets
patient_table <- inner_join(df2, SENB_noCCA) %>% 
  select(-cca_bl_date) %>%
  select(pid, enrol_d, cca_res, hiv_status)

reactable(patient_table)

write.csv(patient_table, file = "SENB_noCCA_n127.csv")
```

```{r}
# delete unnecessary datasets
rm(list = "bl_schisto_long_25052024_BW")
rm(list = "df2", "CCA_Fb_long")
```


## Create 'SENBmono_noCCA' dataset with (mono-infected) patients who have never been tested for CCA (n = 78)

```{r}
SENBmono_noCCA <- bl_schisto_wide_25052024_noCoInf %>%
  select(pid, cca_res, cca_bl_date, fibs_med_res, fibs_iqr_res, cap_med_res, cap_iqr_res) %>%
  rename(fibs_med = fibs_med_res) %>% 
  rename(fibs_iqr = fibs_iqr_res) %>% 
  rename(cap_med = cap_med_res) %>% 
  rename(cap_iqr = cap_iqr_res) %>% 
  filter(is.na(cca_res))

reactable(SENBmono_noCCA)

# checking for duplicates
SENBmono_noCCA %>% 
  get_dupes
```


# SOCIO-DEMOGRAPHICS

## Create temporary dataset with all socio-demographic variables

```{r}
sociodemo1 <- bl_schisto_wide_25052024_noCoInf %>%
  select(1:23) %>%
  mutate(country_orig = case_when(is.na(country_orig) ~ "Senegal",              # rename all 'NA' values in `country_orig` to 'Senegal'
                                  !is.na(country_orig) ~ country_orig)) %>%
  mutate(region_orig = case_when(!is.na(region_orig) ~ region_orig,             # rename all 'NA' values in `region_orig` to their country of origin
                                 is.na(region_orig) ~ country_orig)) %>%
  mutate(dpt_orig = case_when(!is.na(dpt_orig) ~ dpt_orig,                      # rename all 'NA' values in `dpt_orig` to their country of origin
                                 is.na(dpt_orig) ~ country_orig)) %>%
  select(-sen_yn)

reactable(sociodemo1)
```

## Select for variables of interest only

```{r}
sociodemo2 <- sociodemo1 %>% 
  select(pid, age_en, sex, country_orig, region_orig, dpt_orig, reg_act, employ, other_employ) %>% 
  mutate(employ = case_when(employ != "other" ~ employ,
                            employ == "other" ~ str_to_lower(other_employ))) %>% 
  select(-other_employ)

reactable(sociodemo2)
```

```{r}
rm(list = "sociodemo1")
```


## Analysis

```{r}
# age
## define median
median_age <- median(sociodemo2$age_en, na.rm = TRUE)

## define categories
age_cat <- sociodemo2 %>% 
  mutate(age_en = case_when(age_en < 31 ~ "18-31",
                         age_en >= 31 ~ ">31"))
age_cat %>%
  tabyl(age_en) %>%
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# sex
sociodemo2 %>% 
  tabyl(sex) %>%
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# origin
## transform "Diurbel " into "Diurbel"
sociodemo2$dpt_orig <- trimws(sociodemo2$dpt_orig)

## define categories
orig_cat <- sociodemo2 %>% 
  mutate(orig_endemicity = case_when(
    region_orig %in% c("Cameroun", "Benin", "Guinea", "Guinea_Bissau", "Ivory_Coast", "Mali", "Mauritania") ~ "Other Country",
    region_orig %in% c("Kédougou", "Tambacounda", "Matam", "Saint_Louis") ~ "≥50% prevalence (high)",
    dpt_orig %in% c("Bounkiling", "Sédhiou", "Medina Yoro Foulah", "Linguère", "Louga") ~ "≥50% prevalence (high)",
    region_orig == "Kaffrine" ~ "10-49% prevalence (moderate)",
    dpt_orig %in% c("Bignognal", "Oussouye", "Kolda", "Vélingara", "Kaolack", "Fatick", "Gossas",
                    "Diurbel", "Bambey", "M'bour") ~ "10-49% prevalence (moderate)",
    dpt_orig %in% c("Ziguinchor", "Nioro du Rip", "Guinguinéo", "Foundiougne", "Mbacké", "Tivaouane", "Thiès", "Kébémer") ~ "1-9.9% prevalence (low)",
    region_orig == "Dakar" ~ "<1% prevalence (non-endemic)",
    dpt_orig == "Goudomp" ~ "<1% prevalence (non-endemic)"
  ))

orig_cat %>%
  tabyl(orig_endemicity) %>%
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# reg_act
reg_act_cat <- sociodemo2 %>% 
  mutate(reg_act = case_when(reg_act == "Dakar" ~ "Dakar",
                                 reg_act != "Dakar" ~ "Outside"))

reg_act_cat %>% 
  tabyl(reg_act) %>%
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# profession ?

rm(list = "age_cat", "orig_cat", "reg_act_cat")
```

## Creation of final sociodemographics table

```{r}
sociodemo_final <- sociodemo2 %>%
  mutate(age_en = case_when(
    age_en < 31 ~ "18-31",
    age_en >= 31 ~ ">31"
  )) %>%
    mutate(orig_endemicity = case_when(
    region_orig %in% c("Cameroun", "Benin", "Guinea", "Guinea_Bissau", "Ivory_Coast", "Mali", "Mauritania") ~ "Other Country",
    region_orig %in% c("Kédougou", "Tambacounda", "Matam", "Saint_Louis") ~ "≥50% prevalence (high)",
    dpt_orig %in% c("Bounkiling", "Sédhiou", "Medina Yoro Foulah", "Linguère", "Louga") ~ "≥50% prevalence (high)",
    region_orig == "Kaffrine" ~ "10-49% prevalence (moderate)",
    dpt_orig %in% c("Bignognal", "Oussouye", "Kolda", "Vélingara", "Kaolack", "Fatick", "Gossas",
                    "Diurbel", "Bambey", "M'bour") ~ "10-49% prevalence (moderate)",
    dpt_orig %in% c("Ziguinchor", "Nioro du Rip", "Guinguinéo", "Foundiougne", "Mbacké", "Tivaouane", "Thiès", "Kébémer") ~ "1-9.9% prevalence (low)",
    region_orig == "Dakar" ~ "<1% prevalence (non-endemic)",
    dpt_orig == "Goudomp" ~ "<1% prevalence (non-endemic)"
  )) %>% 
  mutate(reg_act = case_when(reg_act == "Dakar" ~ "Dakar",
                                 reg_act != "Dakar" ~ "Outside")) %>% 
  rename(age_cat = age_en) %>% 
  select(pid, age_cat, sex, country_orig, region_orig, dpt_orig, orig_endemicity, reg_act, employ)

reactable(sociodemo_final)
```

```{r}
rm(list = "sociodemo1", "sociodemo2")
```


# COMORBIDITIES

## Create temporary dataset with all comorbidities variables

```{r}
# recreate variable 'HTA' following definition : Confirmed arterial systolic pressure ≥140 mmHg and/or arterial diastolic pressure ≥90 mmHg, or any anti-hypertensive treatment before inclusion in SEN-B (source : WHO, https://www.who.int/news-room/fact-sheets/detail/hypertension, updated 16 March 2023)
bl_schisto_wide_25052024_noCoInf <- bl_schisto_wide_25052024_noCoInf %>% 
  mutate(HTA_diff = aHTA_start - enrol_d) %>%
  mutate(HTA = case_when(!is.na(HTA_diff) ~ "yes",
                         tas >= 140 ~ "yes",
                         tad >= 90 ~ "yes",
                         TRUE ~ "no")) %>% 
  select(-HTA_diff)

# recreate variable 'diabete' ?
bl_schisto_wide_25052024_noCoInf %>% 
  select(diabete, glu_res) %>% 
  filter(diabete == "yes")

# create variable 'dyslipidemia' : Total cholesterol >2g/l, HDL-c <0.4 g/l in men and <0.5 g/l in women, triglycerides >1.5 g/l, or LDL-cholesterol >1 g/l (source : https://www.ncbi.nlm.nih.gov/books/NBK560891/, updated 4 March 2024)
bl_schisto_wide_25052024_noCoInf <- bl_schisto_wide_25052024_noCoInf %>%
  mutate(dyslipidemia = case_when(colt_res > 2 ~ "yes",
                                  trg_res > 1.5 ~ "yes",
                                  ldl_res > 1 ~ "yes",
                                  sex == "Female" & hdl_res < 0.4 ~ "yes",
                                  sex == "Male" & hdl_res < 0.5 ~ "yes",
                                  TRUE ~ "no"))

# round 'BMI' to only 1 digit
bl_schisto_wide_25052024_noCoInf$BMI <- round(bl_schisto_wide_25052024_noCoInf$BMI, 1)

como1 <- bl_schisto_wide_25052024_noCoInf %>% 
  select(pid, sex, alcohol_cons, audit_tot, drugs, smoke_yn, HTA, diabete, BMI, dyslipidemia, COL, AVC, renal, cancer, liver_dis_FDR, hcc_FDR)

reactable(como1)
```

## Analysis

```{r}
# alcohol consumption
como1 %>% 
  tabyl(alcohol_cons) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# audit-c (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10163557/)
audit_cat <- como1 %>% 
  mutate(audit_cat = case_when(sex == "Female" & audit_tot >= 3 ~ "Misuse",
                               sex == "Male" & audit_tot >= 4 ~ "Misuse",
                               audit_tot >= 10 ~ "Addiction",
                               TRUE ~ "Negative"))

audit_cat %>% 
  tabyl(audit_cat) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# drugs
como1 %>% 
  tabyl(drugs) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# smoking
como1 %>% 
  tabyl(smoke_yn) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# HTA
como1 %>% 
  tabyl(HTA) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# diabete
como1 %>% 
  tabyl(diabete) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# BMI (https://www.ncbi.nlm.nih.gov/books/NBK541070/)
BMI_cat <- como1 %>% 
  mutate(BMI_cat = case_when(BMI < 18.5 ~ "underweight",
                             BMI >= 18.5 & BMI < 25 ~ "normal weight",
                             BMI >= 25 & BMI < 30 ~ "overweight",
                             BMI >= 30 ~ "obesity"))

BMI_cat %>% 
  tabyl(BMI_cat) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# dyslipidemia
como1 %>% 
  tabyl(dyslipidemia) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# variable 'COL' (?)
como1 %>% 
  tabyl(COL) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# AVC
como1 %>% 
  tabyl(AVC) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# variable 'renal' (?)
como1 %>% 
  tabyl(renal) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# Cancer
como1 %>% 
  tabyl(cancer) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# Liver Disease
como1 %>% 
  tabyl(liver_dis_FDR) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# CHC Familial
como1 %>% 
  tabyl(hcc_FDR) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# supprimer les objets crées de l'environnement
rm(list = "audit_cat", "BMI_cat")
```

```{r}
# supprimer les variables peu intéressantes après l'analyse descriptive
como2 <- como1 %>%
  select(pid, sex, alcohol_cons, audit_tot, drugs, smoke_yn, HTA, diabete, BMI, dyslipidemia, liver_dis_FDR, hcc_FDR) %>%
  mutate(audit = case_when(sex == "Female" & audit_tot >= 3 ~ "Misuse",
                               sex == "Male" & audit_tot >= 4 ~ "Misuse",
                               audit_tot >= 10 ~ "Addiction",
                               TRUE ~ "Negative")) %>% 
  mutate(BMI = case_when(BMI < 18.5 ~ "underweight",
                             BMI >= 18.5 & BMI < 25 ~ "normal weight",
                             BMI >= 25 & BMI < 30 ~ "overweight",
                             BMI >= 30 ~ "obesity")) %>% 
  select(pid, sex, alcohol_cons, audit, drugs, smoke_yn, HTA, diabete, BMI, dyslipidemia, liver_dis_FDR, hcc_FDR)

reactable(como2)
```

```{r}
rm(list = "como1")
```


## Join sociodemographics & comorbidities datasets

```{r}
sociodemo_como <- left_join(sociodemo_final, como2, by = "pid") %>% 
  rename(sex = sex.x) %>% 
  select(-sex.y)
```

```{r}
# delete unnecessary tables
rm(list = "sociodemo_final", "como2")
```

I forgot to add the "dipstick EtG" variable...

```{r}
bl_schisto_wide_25052024_noCoInf

# create table with 'pid' and 'etg_res'
dipstick_etg <- bl_schisto_wide_25052024_noCoInf %>% 
  select(pid, etg_res)

# join 'dipstick_etg' with sociodemo_como
sociodemo_como <- left_join(sociodemo_como, dipstick_etg, by = "pid") %>% 
  select(pid, age_cat, sex, country_orig, region_orig, dpt_orig, orig_endemicity, reg_act, employ, alcohol_cons, audit, etg_res,
         drugs, smoke_yn, HTA, diabete, BMI, dyslipidemia, liver_dis_FDR, hcc_FDR)

# delete 'dipstick_etg' table
rm(list = "dipstick_etg")
```

## Now we got the full sociodemographics + comorbidities table

```{r}
reactable(sociodemo_como)
```

# HBV MARKERS

## Create temporary dataset with all 'HBV markers' variables

```{r}
hbv_markers <- bl_schisto_wide_25052024_noCoInf %>% 
  select(pid, enrol_d, cvb_res, qAgHBs_res, AgHBe_res) 

# create variable "screen_d" with just the year
hbv_markers <- hbv_markers %>% 
  mutate(screen_d = year(enrol_d)) %>% 
  select(-enrol_d) %>% 
  select(pid, screen_d, cvb_res, qAgHBs_res, AgHBe_res)

# categorize variable 'cvb_res' : <20, 20-2000, 2001-20000, >20000 IU/mL (source : https://doi.org/10.1016/S2468-1253(24)00040-2)
hbv_markers <- hbv_markers %>% 
  mutate(cvb_detection = case_when(cvb_res <= 20 ~ "≤20 IU/mL",
                             cvb_res > 20 & cvb_res <= 2000 ~ "21-2000 IU/mL",
                             cvb_res > 2000 & cvb_res < 20000 ~ "2001-20000 IU/mL",
                             TRUE ~ "≥20000 IU/mL")) %>% 
  select(pid, screen_d, cvb_res, cvb_detection, qAgHBs_res, AgHBe_res)

# categorize variable 'qAgHBs_res' : <100, 100-1000, >1000 (source : Ouzan, 2014)
hbv_markers <-  hbv_markers %>% 
  mutate(qAgHBs_cat = case_when(qAgHBs_res < 100 ~ "<100 IU/mL",
                                qAgHBs_res > 1000 ~ ">1000 IU/mL",
                                TRUE ~ "100-1000 IU/mL")) %>% 
  select(pid, screen_d, cvb_res, cvb_detection, qAgHBs_res, qAgHBs_cat, AgHBe_res)

reactable(hbv_markers)
```

## Analysis

```{r}
# Screening date
hbv_markers %>% 
  tabyl(screen_d) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# HBV DNA viral load
hbv_markers %>% 
  tabyl(cvb_detection) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# qAgHBs
hbv_markers %>% 
  tabyl(qAgHBs_cat) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# AgHbe
hbv_markers %>% 
  tabyl(AgHBe_res) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)
```

## Join 'hbv_markers' with 'sociodemo_como'

```{r}
SchistoHBV <- left_join(sociodemo_como, hbv_markers, by = "pid") %>% 
  select(pid, screen_d, age_cat, sex, country_orig, region_orig,
         orig_endemicity, reg_act, employ, alcohol_cons, audit, 
         etg_res, drugs, smoke_yn, HTA, diabete, BMI, dyslipidemia, 
         liver_dis_FDR, hcc_FDR, cvb_detection, 
         qAgHBs_cat, AgHBe_res)

reactable(SchistoHBV)
```

```{r}
rm(list = "sociodemo_como", "hbv_markers")
```


# HCV/HDV MARKERS

## Create temporary dataset with all 'HCV/HDV markers' variables

```{r}
hcv_hdv_markers <- bl_schisto_wide_25052024_noCoInf %>% 
  select(pid, AcVHC_res, AcVHD_res)

reactable(hcv_hdv_markers)
```

## Analysis

```{r}
# HCV
hcv_hdv_markers %>% 
  tabyl(AcVHC_res) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# HDV
hcv_hdv_markers %>% 
  tabyl(AcVHD_res) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)
```


# TDF Treatment

## Create temporary dataset with all 'TDF' variables

```{r}
bl_schisto_wide_25052024_noCoInf %>% 
  tabyl(on_TDF_bl)

TDF_ttt <- bl_schisto_wide_25052024_noCoInf %>% 
  select(pid, enrol_d, on_TDF_bl, TDF_start) %>% 
  mutate(on_TDF_bl = case_when(is.na(on_TDF_bl) ~ "No",
                               on_TDF_bl == "FALSE" ~"No",
                               on_TDF_bl == "TRUE" ~ "Yes")) %>% 
  mutate(TDF_duration = case_when(on_TDF_bl == "No" ~ 0,
                                  on_TDF_bl == "Yes" ~ as.numeric(TDF_start - enrol_d))) %>% 
  select(-TDF_start) %>% 
  select(-enrol_d)

reactable(TDF_ttt)
```

## Analysis

```{r}
TDF_ttt %>% 
  tabyl(on_TDF_bl) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

library(broom)

# Filter patients treated before baseline
patients_TDF_bl <- TDF_ttt %>% 
  filter(on_TDF_bl == "Yes")

# Median TDF duration at baseline and confidence interval for the median
summary_TDF_duration <- patients_TDF_bl %>%
  summarise(
    median_TDF_duration = median(abs(as.numeric(TDF_duration)), na.rm = TRUE),
    CI95 = list(broom::tidy(quantile(abs(as.numeric(TDF_duration)), probs = c(0.025, 0.975), na.rm = TRUE)))
  )

median_TDF_duration <- summary_TDF_duration$median_TDF_duration
CI95_lower <- summary_TDF_duration$CI95[[1]]$x[1]
CI95_upper <- summary_TDF_duration$CI95[[1]]$x[2]

median_TDF_duration
CI95_lower
CI95_upper

```

```{r}
rm(list = "summary_TDF_duration", "patients_TDF_bl")
```

## Join 'TDF_ttt' with 'hcv_hdv_markers' and then with the 'SchistoHBV' dataset

```{r}
df <- left_join(hcv_hdv_markers, TDF_ttt, by = "pid")

SchistoHBV <- left_join(SchistoHBV, df, by = "pid") %>% 
  mutate(employ = str_to_title(employ),
         alcohol_cons = str_to_title(alcohol_cons),
         drugs = str_to_title(drugs),
         smoke_yn = str_to_title(smoke_yn),
         HTA = str_to_title(HTA),
         diabete = str_to_title(diabete),
         BMI = str_to_title(BMI),
         dyslipidemia = str_to_title(dyslipidemia),
         liver_dis_FDR = str_to_title(liver_dis_FDR),
         hcc_FDR = str_to_title(hcc_FDR))

reactable(SchistoHBV)
```

```{r}
rm(list = "df", "TDF_ttt", "hcv_hdv_markers")
```


# LIVER MARKERS

## Create temporary dataset with all liver markers

```{r}
liver_markers <- bl_schisto_wide_25052024_noCoInf %>% 
  select(pid, sex, alt_res, ast_res, plt_res, fibs_med_res, cap_med_res) %>%
  mutate(apri_score = ((ast_res/40)*100)/plt_res*1000) %>%
  mutate(apri_score = round(apri_score, 2)) %>%
  # recategorize variables
  mutate(alt_res = case_when(alt_res <= 40 ~ "≤40 IU/L",
                             alt_res > 80 ~ ">80 IU/L",
                             TRUE ~ "41-80 IU/L"),
         alt_elevated = case_when(sex == "Male" & alt_res > 32 ~ "High",
                             sex == "Female" & alt_res > 19 ~ "High",
                             TRUE ~ "Normal"),
         apri_diag = case_when(apri_score > 1.5 ~ "Fibrosis",
                               apri_score < 0.6 ~ "No Fibrosis",
                               is.na(apri_score) ~ "NA",
                               TRUE ~ "Unknown"),
         fibs_med_diag = case_when(fibs_med_res <= 7.0 ~ "F0-1 (no or mild fibrosis)",
                                   fibs_med_res > 7.0 & fibs_med_res < 11.1 ~ "F2–3 (significant fibrosis)",
                                   fibs_med_res >= 11.1 ~ "F4 (cirrhosis)",
                                   is.na(fibs_med_res) ~ "NA"),
         fibs7 = case_when(fibs_med_res >= 7.1 ~ "≥7.1 kPa",
                           TRUE ~ "<7.0 kPa"),
         fibs11 = case_when(fibs_med_res >= 11.1 ~ "≥11.1 kPa",
                           TRUE ~ "<11.0 kPa"),
         cap_med_diag = case_when(cap_med_res >= 248 ~ "SLD",
                                  is.na(cap_med_res) ~ "NA",
                                  TRUE ~ "Normal")
         ) %>% 
  select(pid, alt_res, alt_elevated, apri_score, apri_diag, fibs_med_res, fibs_med_diag, fibs7, fibs11, cap_med_res, cap_med_diag)

# SOURCES : Lala V, Zubair M, Minter DA. Liver Function Tests. [Updated 2023 Jul 30]. In: StatPearls [Internet]. Treasure Island (FL): StatPearls Publishing; 2024 Jan-. Available from: https://www.ncbi.nlm.nih.gov/books/NBK482489
## APRI :
## Fibrosis : Morse, C.G., et al., Transient elastography for the detection of hepatic fibrosis in HIV-monoinfected adults with elevated aminotransferases on antiretroviral therapy. Aids, 2015. 29(17): p. 2297-302.
## Steatosis : Karlas, T., et al., Individual patient data meta-analysis of controlled attenuation parameter (CAP) technology for assessing steatosis. J Hepatol, 2017. 66(5): p. 1022-1030.

reactable(liver_markers)
```

## Analysis

```{r}
# ALAT
liver_markers %>%
  tabyl(alt_res) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# APRI
liver_markers %>%
  tabyl(apri_diag) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)
  
# FibroScan LSM
liver_markers %>%
  tabyl(fibs_med_diag) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# LSM ≥ 7.1 kPa
liver_markers %>%
  tabyl(fibs7) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# LSM ≥ 11.1 kPa
liver_markers %>%
  tabyl(fibs11) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# FibroScan CAP
liver_markers %>%
  tabyl(cap_med_diag) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)
```

### I want to identify how many patients have discordant fibrosis diagnoses between 'apri_diag' and 'fibs_med_diag'

```{r}
discordant_patients <- liver_markers %>%
  filter((apri_diag == "No Fibrosis" & fibs_med_diag != "F0-1 (no or mild fibrosis)") |
         (apri_diag == "Fibrosis" & fibs_med_diag == "F0-1 (no or mild fibrosis)"))

# Print discordant patients (n=78)
reactable(discordant_patients)
```

## Join 'liver_markers' with 'SchistoHBV' dataset

```{r}
SchistoHBV <- left_join(SchistoHBV, liver_markers, by = "pid")
reactable(SchistoHBV)
```


# URINE MARKERS

## Create temporary dataset with all 'urine markers' variables needed

```{r}
urine_markers <- bl_schisto_wide_25052024_noCoInf %>% 
  select(pid, protu_res, creu_res, leubu_res, hembu_res, protbu_res)

# create 'protein/creatinine ratio' variable (https://doi.org/10.1080/10408363.2020.1723487)
urine_markers <- urine_markers %>% 
  mutate(upcr_ratio = protu_res / creu_res) %>%
  mutate(upcr_ratio = round(upcr_ratio, 2)) %>% 
  mutate(upcr_diag = case_when(upcr_ratio > 0.2 ~ "Proteinuria (>0.2 mg/mg)",
                               TRUE ~ "Normal (≤0.2 mg/mg)")) %>%
# recategorize urine strip variables
  mutate(leubu_res = case_when(leubu_res >= 1 ~ "Leukocyturia",
                               leubu_res < 1 ~ "Normal")) %>%
  mutate(hembu_res = case_when(hembu_res >= 1 ~ "Hematuria",
                               hembu_res < 1 ~ "Normal")) %>%  
  mutate(protbu_res = case_when(protbu_res >= 1 ~ "Proteinuria",
                               protbu_res < 1 ~ "Normal")) %>%
  select(pid, protu_res, creu_res, upcr_ratio, upcr_diag, leubu_res, hembu_res, protbu_res)

reactable(urine_markers)

# source : 
```

## Analysis

```{r}
# UPCR Ratio
urine_markers %>% 
  tabyl(upcr_diag) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# LEUBU
urine_markers %>% 
  tabyl(leubu_res) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# HEMBU
urine_markers %>% 
  tabyl(hembu_res) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# PROTBU
urine_markers %>% 
  tabyl(protbu_res) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)
```

- There is a problem with the UPCR ratio right ?
- NAs ? (n=2)

## Join 'urine_markers' with 'SchistoHBV'
```{r}
SchistoHBV <- left_join(SchistoHBV, urine_markers, by = "pid")
```


# ULTRASOUND (US) DATA

## Create temporary dataset with all 'Ultrasound' variables needed

```{r}
bl_schisto_wide_25052024_noCoInf
```

# OTHER MARKERS

## Create temporary dataset with all 'Other markers' needed

```{r}
other_markers <- bl_schisto_wide_25052024_noCoInf %>% 
  select(pid, trad_med, trad_med_type, plants_type, trad_other, cre_res, age_en, sex)

# trad_med
other_markers <- other_markers %>% 
  mutate(trad_med = case_when(trad_med == "no" ~ "None",
                              trad_med == "yes" & trad_med_type == "plant" ~ "Plant",
                              trad_med == "yes" & trad_med_type == "other" ~ "Oil/Powder",
                              is.na(trad_med) ~ "None"))

# eGFR
other_markers <- other_markers %>%
  mutate(
    eGFR = case_when(
      sex == 'Female' & cre_res <= 7 ~ 144 * (cre_res / 7)^(-0.329) * 0.993^age_en,
      sex == 'Female' & cre_res > 7  ~ 144 * (cre_res / 7)^(-1.209) * 0.993^age_en,
      sex == 'Male' & cre_res <= 9   ~ 141 * (cre_res / 9)^(-0.411) * 0.993^age_en,
      sex == 'Male' & cre_res > 9    ~ 141 * (cre_res / 9)^(-1.209) * 0.993^age_en,
      TRUE                           ~ NA_real_  # Use NA for any other cases (e.g., missing sex)
    )
  )

# eGFR diagnosis
other_markers <- other_markers %>% 
  mutate(eGFR_diag = case_when(eGFR >= 60 ~ "≥60",
                               eGFR <= 15 ~ "≤15",
                               TRUE ~ "15-60")) %>% 
  select(pid, trad_med, eGFR, eGFR_diag)
```

## Analysis

```{r}
# Traditional medicine
other_markers %>% 
  tabyl(trad_med) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)

# eGFR
other_markers %>% 
  tabyl(eGFR_diag) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting(digits = 2)
```

## Join 'other_markers' with 'SchistoHBV' dataset

```{r}
SchistoHBV <- left_join(SchistoHBV, other_markers, by = "pid")
```

# ADD CCA RESULTS

```{r}
cca_result <- bl_schisto_wide_25052024_noCoInf %>% 
  select(pid, cca_res, enrol_d, cca_bl_date) %>% 
  mutate(diff_cca = cca_bl_date - enrol_d) %>%
  select(-enrol_d)

SchistoHBV <- left_join(SchistoHBV, cca_result, by = "pid")
```

```{r}
write.csv(SchistoHBV, file = "SchistoHBV_20240625.csv")
```

# ANALYSIS

## Prevalence

```{r}
cases <- CCA_Fb %>% filter(cca_res == "Positive") %>% nrow()

subjects <- CCA_Fb %>% nrow()

prevalence <- round((cases/subjects)*100, 1)

print(paste0("The prevalence of schistosomiasis among people living with HBV in Dakar is ", prevalence, "%"))
```


## Table 1

```{r}
SchistoHBV %>%
  select(-pid, -country_orig, -region_orig, -employ, -TDF_duration, -alt_elevated, -apri_score, -fibs_med_res, -fibs7, -fibs11, -cap_med_res, -protu_res, 
         -creu_res, -upcr_ratio, -eGFR, -cca_bl_date, -diff_cca) %>%
  mutate(age_cat = factor(age_cat, levels = c("18-31", ">31"))) %>%
  mutate(orig_endemicity = factor(orig_endemicity, levels = c("<1% prevalence (non-endemic)", "1-9.9% prevalence (low)", 
                                                              "10-49% prevalence (moderate)", "≥50% prevalence (high)", "Other Country"))) %>%
  mutate(alcohol_cons = factor(alcohol_cons, levels = c("Yes_past", "No"))) %>% 
  mutate(drugs = factor(drugs, levels = c("Yes_now", "Yes_past", "No"))) %>% 
  mutate(smoke_yn = factor(smoke_yn, levels = c("Yes_now", "Yes_past", "No"))) %>% 
  mutate(BMI = factor(BMI, levels = c("Normal Weight", "Underweight", "Overweight", "Obesity"))) %>% 
  mutate(cvb_detection = factor(cvb_detection, levels = c("≤20 IU/mL", "21-2000 IU/mL", "2001-20000 IU/mL", "≥20000 IU/mL"))) %>% 
  mutate(qAgHBs_cat = factor(qAgHBs_cat, levels = c("<100 IU/mL", "100-1000 IU/mL", ">1000 IU/mL"))) %>% 
  mutate(alt_res = factor(alt_res, levels = c("≤40 IU/L", "41-80 IU/L", ">80 IU/L"))) %>% 
  mutate(cap_med_diag = factor(cap_med_diag, levels = c("SLD", "Normal"))) %>%
  mutate(upcr_diag = factor(upcr_diag, levels = c("Proteinuria (>0.2 mg/mg)", "Normal (<0.2 mg/mg)"))) %>% 
  mutate(protbu_res = factor(protbu_res, levels = c("Proteinuria", "Normal"))) %>%
  mutate(trad_med = factor(trad_med, levels = c("Plant", "Oil/Powder", "None"))) %>%
  mutate(cca_res = factor(cca_res, levels = c("Positive", "Negative"))) %>% 
  tbl_summary(by = sex,
              missing = "no",
              statistic = list(all_categorical() ~ "{n} / {N} ({p}%)"),
              missing_text = "(Missing)",
              label = list(screen_d ~ "Screening Year", age_cat ~ "Age", orig_endemicity ~ "Origin", reg_act ~ "Residence", 
                           alcohol_cons ~ "Alcohol Consumption", audit ~ "AUDIT-C Score", etg_res ~ "Dipstick EtG", 
                           drugs ~ "Drug Consumption", smoke_yn ~ "Smoking", HTA ~ "Hypertension", diabete ~ "Diabetes", 
                           dyslipidemia ~ "Dyslipidemia", liver_dis_FDR ~ "Family History of Liver Disease", 
                           hcc_FDR ~ "Family History of HCC", cvb_detection ~ "HBV viral load", qAgHBs_cat ~ "qAgHBs", 
                           AgHBe_res ~ "AgHBe", AcVHC_res ~ "HCV Serology", AcVHD_res ~ "HDV Serology", on_TDF_bl ~ "On TDF at Baseline",
                           alt_res ~ "ALAT", apri_diag ~ "APRI Score", fibs_med_diag ~ "FibroScan LSM", cap_med_diag ~ "FibroScan CAP", 
                           upcr_diag ~ "UPCR Ratio", leubu_res ~ "Leukocyturia (Urine Strips)", hembu_res ~ "Hematuria (Urine Strips)", 
                           protbu_res ~ "Proteinuria (Urine Strips)", trad_med ~ "Traditional Medicine", eGFR_diag ~ "eGFR", 
                           cca_res ~ "CCA Result")) %>%
  add_overall(last = TRUE, col_label = "**Total** (N = {N})") %>% 
  add_p(pvalue_fun = ~ style_pvalue(.x, digits = 2)) %>%
  modify_header(label ~ "**Variable**") %>%
  modify_caption("**Table 1. Patient Characteristics**") %>%
  bold_labels() %>% 
  as_gt()
```

## Table 2

```{r}
SchistoHBV %>%
  select(-pid, -country_orig, -region_orig, -employ, -TDF_duration, -alt_elevated, -apri_score, -fibs_med_res, -fibs7, -fibs11, -cap_med_res, -protu_res, 
         -creu_res, -upcr_ratio, -eGFR, -cca_bl_date, -diff_cca) %>%
  mutate(age_cat = factor(age_cat, levels = c("18-31", ">31"))) %>%
  mutate(orig_endemicity = factor(orig_endemicity, levels = c("<1% prevalence (non-endemic)", "1-9.9% prevalence (low)", 
                                                              "10-49% prevalence (moderate)", "≥50% prevalence (high)", "Other Country"))) %>%
  mutate(alcohol_cons = factor(alcohol_cons, levels = c("Yes_past", "No"))) %>% 
  mutate(drugs = factor(drugs, levels = c("Yes_now", "Yes_past", "No"))) %>% 
  mutate(smoke_yn = factor(smoke_yn, levels = c("Yes_now", "Yes_past", "No"))) %>% 
  mutate(BMI = factor(BMI, levels = c("Normal Weight", "Underweight", "Overweight", "Obesity"))) %>% 
  mutate(cvb_detection = factor(cvb_detection, levels = c("≤20 IU/mL", "21-2000 IU/mL", "2001-20000 IU/mL", "≥20000 IU/mL"))) %>% 
  mutate(qAgHBs_cat = factor(qAgHBs_cat, levels = c("<100 IU/mL", "100-1000 IU/mL", ">1000 IU/mL"))) %>% 
  mutate(alt_res = factor(alt_res, levels = c("≤40 IU/L", "41-80 IU/L", ">80 IU/L"))) %>% 
  mutate(cap_med_diag = factor(cap_med_diag, levels = c("SLD", "Normal"))) %>%
  mutate(upcr_diag = factor(upcr_diag, levels = c("Proteinuria (>0.2 mg/mg)", "Normal (<0.2 mg/mg)"))) %>% 
  mutate(protbu_res = factor(protbu_res, levels = c("Proteinuria", "Normal"))) %>%
  mutate(trad_med = factor(trad_med, levels = c("Plant", "Oil/Powder", "None"))) %>%
  tbl_summary(by = cca_res,
              missing = "no",
              statistic = list(all_categorical() ~ "{n} / {N} ({p}%)"),
              missing_text = "(Missing)",
              label = list(screen_d ~ "Screening Year", age_cat ~ "Age", orig_endemicity ~ "Origin", reg_act ~ "Residence", 
                           alcohol_cons ~ "Alcohol Consumption", audit ~ "AUDIT-C Score", etg_res ~ "Dipstick EtG", 
                           drugs ~ "Drug Consumption", smoke_yn ~ "Smoking", HTA ~ "Hypertension", diabete ~ "Diabetes", 
                           dyslipidemia ~ "Dyslipidemia", liver_dis_FDR ~ "Family History of Liver Disease", 
                           hcc_FDR ~ "Family History of HCC", cvb_detection ~ "HBV viral load", qAgHBs_cat ~ "qAgHBs", 
                           AgHBe_res ~ "AgHBe", AcVHC_res ~ "HCV Serology", AcVHD_res ~ "HDV Serology", on_TDF_bl ~ "On TDF at Baseline",
                           alt_res ~ "ALAT", apri_diag ~ "APRI Score", fibs_med_diag ~ "FibroScan LSM", cap_med_diag ~ "FibroScan CAP", 
                           upcr_diag ~ "UPCR Ratio", leubu_res ~ "Leukocyturia (Urine Strips)", hembu_res ~ "Hematuria (Urine Strips)", 
                           protbu_res ~ "Proteinuria (Urine Strips)", trad_med ~ "Traditional Medicine", eGFR_diag ~ "eGFR")) %>%
  add_overall(last = TRUE, col_label = "**Total** (N = {N})") %>% 
  add_p(pvalue_fun = ~ style_pvalue(.x, digits = 2)) %>%
  modify_header(label ~ "**Variable**") %>%
  modify_spanning_header(c("stat_1", "stat_2") ~ "**CCA Result**") %>%
  modify_caption("**Table 2. Patient Characteristics**") %>%
  bold_labels() %>% 
  as_gt()
```
